# プロジェクト計画: AI推論プロキシサーバー

## フェーズ0: 計画の準備とスコープ定義

**目的:**
【解説】このフェーズは、本格的な開発に着手する前の準備段階です。プロジェクトの目的を明確にし、最初に作るべき最小限の範囲（MVP）を定義し、開発を進めるためのツールやルールを整えることを目的とします。ここでの決定が、プロジェクト全体の方向性を左右します。

**想定期間:**
【解説】このフェーズにどれくらいの期間を見込むかを記述します。個人プロジェクトであれば、集中して半日〜1日程度、あるいは他の作業と並行して数日〜0.5週間程度が目安です。
【記入例】0.5週

---

### 1. 目標の再確認

**【解説】**
なぜこのプロジェクトを行うのか、その根本的な動機と目指す姿を再確認し、言語化します。これにより、プロジェクトの軸がぶれなくなり、後の意思決定（特に機能の取捨選択）の基準となります。

* **背景:**
  * 【解説】プロジェクトが生まれたきっかけや、現状認識している課題、技術的な背景などを記述します。
  * 【記入例】
    * ローカルPCで動作する多様な機械学習モデルが増加している。
    * これらのモデルを効率的に利用するには、コンテナの起動・停止管理が必要だが、手動で行うのは煩雑。
    * 各モデルのエンドポイントを個別に管理・設定する必要があり、手間がかかる。
    * ローカルPCの限られたリソース（特にGPU VRAM）を有効活用したい。
    * 各コンテナは個別のエンドポイントを持つがそれらを統一的なエンドポイントからのアクセスで利用できるようにしたい。

* **プロジェクトのゴール:**
  * 【解説】このプロジェクトを通じて最終的に達成したい状態、理想的な姿を具体的に記述します。
  * 【記入例】
    * ユーザーがローカル環境で複数のAIモデルを、リソースやエンドポイント管理の手間を意識せずに、単一のインターフェースから利用できるプロキシサーバーを提供する。
    * コンテナのライフサイクル管理とリソースの自動調整を実現し、ローカルAI環境の利便性を向上させる。
    * ユーザーがそれぞれの推論サーバーが実行中がどうかを意識せずに推論サービスを利用できる。
    * 推論サーバーの中にはモデルの切り替えなどの機能を持つものがあり、それらを意識せずに利用できる。

* **解決したいユーザー課題:**
  * 【解説】ユーザー（この場合は開発者自身や他のローカルAIユーザー）が現在抱えている具体的な問題点や不満をリストアップします。草案の「課題」セクションを具体化します。
  * 【記入例】
    * 推論サーバーコンテナの起動・停止を手動で行う必要がある。
    * PCのリソース状況を目視で確認し、手動でコンテナを調整する必要がある。
    * 利用するアプリケーションごとに、モデルのエンドポイント設定を個別に行う必要がある。
    * 未使用のコンテナがリソースを占有し続けてしまう。
    * 新しいモデルを追加する際の設定が煩雑。

* **提供価値:**
  * 【解説】このプロジェクトが成功した場合、ユーザーにどのようなメリットや価値を提供できるかを記述します。
  * 【記入例】
    * **手間の削減:** コンテナの手動管理やエンドポイントの個別設定が不要になる。
    * **リソース効率化:** リソースの自動解放により、限られたPCリソースを有効活用できる。
    * **利便性向上:** 単一のエンドポイントで複数のモデルを利用可能になる。
    * **設定の簡素化:** テンプレート利用により、モデル追加時の設定が容易になる。
    * **可観測性:** OpenTelemetryとSigNozにより、システムの動作状況を把握しやすくなる。
    * **統計:** 各モデルの利用状況やリソース使用量を統計で確認できる。

---

### 2. スコープ定義

**【解説】**
プロジェクト全体で実現したい機能の中から、最初にリリースする「最小限の価値を提供する製品（MVP）」の範囲を明確にします。同時に、MVPには含めないが将来的には実装したい機能もリストアップし、プロジェクトのロードマップの基礎を作ります。

#### 2.1. MVP (Minimum Viable Product) の定義

**【解説】**
MVPは、ユーザーの最も重要な課題を解決できる最小限の機能セットです。完璧を目指さず、早く価値を提供し、フィードバックを得ることを重視します。「何を含め、何を含めないか」を明確にすることが重要です。

* **MVPコンセプト:**
  * 【解説】MVPが提供する中核的な価値を一言で表現します。
  * 【記入例】設定ファイルに基づき、指定された単一種類の推論サーバー（例: llama.cpp）コンテナを手動APIで起動・停止でき、そのコンテナへリクエストをプロキシできるサーバー。

* **MVPの主要機能:**
  * 【解説】MVPとして実装する具体的な機能をリストアップします。必要最低限に絞り込みます。
  * 【記入例】
    * **設定ファイル読み込み:** YAML形式の設定ファイルを読み込み、サービス定義（ポート、コンテナイメージ、基本的な引数）を解釈する。(`server`セクション、`services`セクションの基本構造)
    * **基本的なプロキシ機能:** `/service/{service_id}/{path}` へのリクエストを、対応するコンテナの指定ポートに転送する。
    * **手動コンテナ管理API:**
      * `POST /api/v1/service/{service_id}/start`: 指定されたサービスIDのコンテナを起動するAPI。（Docker SDK を使用）
      * `POST /api/v1/service/{service_id}/stop`: 指定されたサービスIDのコンテナを停止するAPI。（Docker SDK を使用）
      * `GET /api/v1/container/{service_id}`: 指定されたサービスIDのコンテナの基本的な状態（実行中か否か）を取得するAPI。(debug用)
    * **基本的なログ出力:** `loguru` を用いて、リクエストやコンテナ操作に関する基本的なログをコンソールに出力する。（`richuru` は初期では必須ではないかも）
    * **単一サービスタイプ対応:** まずは `llama-cpp-server` のような特定の1種類のコンテナタイプのみを対象とする。（テンプレート化はMVP以降）
    * **基本的なDocker連携:** PythonからDockerデーモンに接続し、コンテナの起動・停止を行う。（NVIDIA Container Toolkit の利用も含む）

* **MVPに含めない機能:**
  * 【解説】MVPのスコープ外とする機能を明確にリストアップします。これにより、開発範囲が不必要に広がることを防ぎます。
  * 【記入例】
    * リクエストに応じた**自動**コンテナ起動機能
    * リソース不足時の**自動**コンテナ停止・リソース解放機能
    * アイドル時の**自動**コンテナ停止機能
    * **高度な**リソース監視（メモリ/VRAM使用量のリアルタイム監視と閾値判定）
    * 複数サービスタイプに対応する**テンプレート機能**
    * **OpenTelemetry/SigNoz** との連携（メトリクス、トレース、ログの外部送信）
    * 手動APIでの `/restart` 機能
    * Web UI
    * 詳細なヘルスチェック機能 (`/health`)
    * 設定ファイルのホットリロード
    * 高度なエラーハンドリングとリトライロジック
    * テストコード（初期の探索的開発段階では省略し、コア機能が固まり次第追加する戦略も可。ただし推奨は早期導入）
    * 完全なAPIドキュメント（OpenAPI Schema生成は実装と並行するが、整形や詳細説明は後回しでも可）

#### 2.2. MVP以降の検討機能 (拡張スコープ候補)

**【解説】**
MVPリリース後、フィードバックや開発の状況に応じて実装を検討する機能のアイデアをリストアップします。優先順位付けは現時点では不要ですが、将来の方向性を示すものとなります。

* 【記入例】
  * **自動化機能:**
    * リクエストトリガーでのコンテナ自動起動
    * リソース（メモリ、VRAM）監視に基づく自動停止・起動制御
    * アイドルタイムアウトによる自動停止
  * **設定と利便性:**
    * `llama.cpp` 以外のサービスのサポート
      * `infinity-embeddings`
      * `tabby api`
      * `vllm`
    * サービスタイプ毎の設定テンプレート機能
    * 設定ファイルのホットリロード
    * より詳細なコンテナ起動オプション（環境変数、ネットワーク設定など）のサポート
  * **監視と運用:**
    * OpenTelemetry (Traces, Metrics, Logs) と SigNoz の完全連携
    * loguru によるログを OpenTelemetry logs に送信して、SigNoz で可視化する。
    * `/metrics` エンドポイントの実装
    * 詳細なコンテナヘルスチェック機能
    * 管理用Web UI (任意)
  * **堅牢性:**
    * 高度なエラーハンドリング（Docker操作失敗時など）
    * エラー統計を取り、典型的なエラーかつ復旧可能なもの(ex. CUDA Out of Memory)についての復旧ロジックの模索
    * リトライロジック
  * **その他:**
    * 対応サービスタイプ（推論サーバー）の拡充
    * 認証機能（必要であれば）
    * プラグイン機構による拡張性

---

### 3. プロジェクト管理ツールの準備

**【解説】**
開発プロセスを効率的かつ体系的に進めるためのツールやルールを設定します。個人プロジェクトであっても、これらのツールを活用することで、コードの品質維持、タスク管理、進捗把握が容易になります。

* **コードリポジトリ:**
  * 【解説】ソースコードをバージョン管理するためのリポジトリを設定します。READMEや.gitignoreも初期段階で準備します。
  * 【記入例】
    * `GitHub` 上にプライベートリポジトリ `ai-inference-proxy` を作成。
    * `README.md` にプロジェクト概要、目標、(将来的に)セットアップ手順を記述開始。
    * Pythonプロジェクト用の `.gitignore` を設定 (例: `__pycache__/`, `*.pyc`, `.env`, `venv/` など)。
    * uv を使って `pyproject.toml` を作成しプロジェクト管理を行う
    * cursorを使うので `.cursor/rules` を作成
    * プロジェクト文書を `docs` ディレクトリに作成

* **Issueトラッキング:**
  * 【解説】開発タスク、バグ報告、機能要望などを管理するためのツールとルールを定めます。Issue駆動開発の基盤となります。
  * 【記入例】
    * `GitHub Issues` を使用する。
    * 初期ラベル案: `Type: Bug`, `Type: Feature`, `Type: Chore`, `Type: Documentation`, `Scope: MVP`, `Priority: High/Medium/Low`。
    * Issueのテンプレートを作成
      * Feature
        * 機能説明
        * ユーザーストーリー(ユーザー価値と、それを実現するための機能要件)
        * タスク個別のタスクとして別のissueに
      * Bug
        * バグの説明
        * 再現手順
        * バグの影響
        * バグの原因
        * バグの修正
      * Documentation
        * ドキュメントの説明
        * ドキュメントの更新
        * ドキュメントの追加
    * フェーズ1以降で洗い出す機能要求やタスクをIssueとして起票していく。

* **カンバンボード (任意):**
  * 【解説】タスクの進捗状況を視覚的に管理したい場合に設定します。個人プロジェクトでは必須ではありませんが、あると便利です。
  * 【記入例】
    * `GitHub Projects` を利用することを検討。
    * カラム案: `Backlog`, `ToDo`, `In Progress`, `Done`。

* **ブランチ戦略:**
  * 【解説】コードの変更履歴を整理し、安定版と開発版を分離するためのルールを定めます。
  * 【記入例】
    * `main` ブランチ: 安定版。直接コミットせず、開発が一段落したら `develop` からマージする。
    * `develop` ブランチ (任意、個人開発なら `main` 直でも可): 開発のベースとなるブランチ。
    * `feature/xxx` ブランチ: 各機能や修正ごとに `develop` (または `main`) から作成し、完了後にPull Request経由でマージする。
    * 例: `feature/add-proxy-endpoint`, `feature/implement-docker-start-stop`

* **コミュニケーション (個人プロジェクトでは省略可):**
  * 【解説】チーム開発の場合、情報共有や議論のためのツールを設定します。
  * 【記入例】個人プロジェクトのため、GitHub Issue/PR上のコメントを主とする。特に追加ツールは設定しない。
